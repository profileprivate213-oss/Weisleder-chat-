<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Weisleder Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#229ED9">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{ --brand:#229ED9; --outgoing:#D1F0FF; }
*::-webkit-scrollbar{width:8px;height:8px}
*::-webkit-scrollbar-thumb{background:rgba(100,100,100,.35);border-radius:9999px}
*{scrollbar-width:thin}
.bubble{ position:relative }
.bubble.in::after{ content:""; position:absolute; left:-6px; bottom:0; border-top:6px solid transparent; border-right:6px solid #fff }
.dark .bubble.in::after{ border-right-color: rgb(30 41 59) }
.bubble.out::after{ content:""; position:absolute; right:-6px; bottom:0; border-top:6px solid transparent; border-left:6px solid var(--outgoing) }
.tick{ font-size:10px; opacity:.7 }
.btn-brand{ background:var(--brand); color:#fff }
.btn-brand:hover{ filter:brightness(.95) }
</style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-50">

<div class="fixed top-0 inset-x-0 z-20 bg-white/90 dark:bg-slate-900/90 backdrop-blur border-b border-slate-200 dark:border-slate-800">
  <div class="max-w-6xl mx-auto px-3 py-2 flex items-center gap-2">
    <div class="hidden md:flex items-center gap-2 font-semibold">
      <svg width="18" height="18" viewBox="0 0 24 24" class="fill-[var(--brand)]"><path d="M22 2 11 13l-1 6 4-3 8-14zM2 12l7 2"/></svg>
      Weisleder Chat
    </div>
    <div class="flex-1"></div>
    <div class="relative w-[62vw] md:w-[420px]">
      <input id="globalEmailSearch" class="w-full pl-3 pr-28 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 outline-none" placeholder="Search user by email"/>
      <button id="globalEmailStart" class="absolute right-1 top-1 bottom-1 px-3 rounded-lg btn-brand text-sm">Start</button>
    </div>
  </div>
</div>

<div id="app" class="min-h-screen flex pt-16" style="display:none">
  <aside class="hidden md:flex w-80 flex-col border-r border-slate-200 dark:border-slate-800">
    <div class="px-3 py-3 flex items-center gap-2 text-white" style="background:var(--brand)">
      <img id="meAvatar" class="h-9 w-9 rounded-full object-cover bg-white/20" alt="avatar"/>
      <div class="flex-1">
        <div id="meName" class="text-sm font-semibold">You</div>
        <div id="meEmail" class="text-xs/4 opacity-80">you@example.com</div>
      </div>
      <button id="btnProfile" class="px-2 py-1 rounded-md bg-white/20 hover:bg-white/30">Edit</button>
    </div>
    <div id="chatList" class="flex-1 overflow-y-auto pb-3 bg-white dark:bg-slate-900"></div>
    <div class="p-3 border-t border-slate-200 dark:border-slate-800 space-y-2">
      <button id="btnNewChat" class="w-full py-2 rounded-xl btn-brand">＋ New chat</button>
      <button id="btnLogout" class="w-full py-2 rounded-xl border">Sign out</button>
    </div>
  </aside>

  <main class="flex-1 flex flex-col">
    <div class="h-14 px-4 flex items-center gap-3 border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80">
      <img id="activeAvatar" class="h-9 w-9 rounded-full object-cover bg-slate-200 dark:bg-slate-700"/>
      <div class="flex-1"><div id="activeName" class="text-sm font-semibold">Select a chat</div></div>
    </div>
    <div id="messageScroll" class="flex-1 overflow-y-auto px-3 md:px-8 py-3 space-y-2"></div>
    <div class="border-t border-slate-200 dark:border-slate-800 p-3 bg-white/80 dark:bg-slate-900/80">
      <div class="max-w-3xl mx-auto flex items-end gap-2">
        <textarea id="composer" class="flex-1 min-h-[44px] max-h-[160px] resize-y rounded-xl bg-slate-100 dark:bg-slate-800 px-3 py-2 outline-none" placeholder="Message"></textarea>
        <button id="btnSend" class="p-2 rounded-lg btn-brand">➤</button>
      </div>
    </div>
  </main>
</div>

<!-- Auth -->
<div id="auth" class="fixed inset-0 grid place-items-center bg-gradient-to-b from-sky-50 to-white dark:from-slate-900 dark:to-slate-900">
  <div class="w-[92vw] max-w-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow p-6 space-y-4">
    <div class="text-center text-2xl font-bold" style="color:var(--brand)">Weisleder Chat</div>
    <div class="grid grid-cols-2 gap-2">
      <button id="goSignup" class="py-2 rounded-xl btn-brand font-medium">Sign up</button>
      <button id="goSignin" class="py-2 rounded-xl border border-slate-200 dark:border-slate-700">Sign in</button>
    </div>
  </div>
</div>

<!-- Sign Up Modal -->
<div id="signup" class="fixed inset-0 hidden place-items-center bg-black/30">
  <div class="w-[92vw] max-w-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow p-6">
    <h2 class="text-lg font-semibold mb-2">Create account</h2>
    <input id="suName" class="w-full mb-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800" placeholder="Name">
    <input id="suEmail" class="w-full mb-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800" placeholder="Email">
    <input id="suPass" type="password" class="w-full mb-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800" placeholder="Password">
    <input id="suPhoto" type="file" accept="image/*" class="mb-2">
    <button id="btnSignup" class="w-full py-2 rounded-xl btn-brand">Create</button>
  </div>
</div>

<!-- Sign In Modal -->
<div id="signin" class="fixed inset-0 hidden place-items-center bg-black/30">
  <div class="w-[92vw] max-w-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow p-6">
    <h2 class="text-lg font-semibold mb-2">Sign in</h2>
    <input id="siEmail" class="w-full mb-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800" placeholder="Email">
    <input id="siPass" type="password" class="w-full mb-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800" placeholder="Password">
    <button id="btnSignin" class="w-full py-2 rounded-xl btn-brand">Sign in</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, addDoc, query, where, getDocs, getDoc, onSnapshot, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

// ✅ Your real Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA2RwR8XUZDosCuQBy7bV0Uj07-6OAw8VU",
  authDomain: "weisleder-chat.firebaseapp.com",
  projectId: "weisleder-chat",
  storageBucket: "weisleder-chat.firebasestorage.app",
  messagingSenderId: "899447625973",
  appId: "1:899447625973:web:c64513e9c1781f46624dbc",
  measurementId: "G-DTFJ7NPZ6C"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const $ = id => document.getElementById(id);
function ping(){const c=new (window.AudioContext||window.webkitAudioContext)();const o=c.createOscillator(),g=c.createGain();o.frequency.value=800;g.gain.value=.08;o.connect(g);g.connect(c.destination);o.start();setTimeout(()=>{o.stop();c.close();},180);}

let currentUser=null,activeThread=null;

$('goSignup').onclick=()=>$('signup').style.display='grid';
$('goSignin').onclick=()=>$('signin').style.display='grid';
$('btnSignup').onclick=async()=>{
 const name=$('suName').value.trim(),email=$('suEmail').value.trim().toLowerCase(),pass=$('suPass').value.trim();
 if(!name||!email||!pass)return alert('Fill all fields');
 const cred=await createUserWithEmailAndPassword(auth,email,pass);
 let photoURL=null;
 if($('suPhoto').files[0]){
  const ref=sRef(storage,`avatars/${cred.user.uid}.jpg`);
  await uploadBytes(ref,$('suPhoto').files[0]);
  photoURL=await getDownloadURL(ref);
 }
 await updateProfile(cred.user,{displayName:name,photoURL});
 await setDoc(doc(db,'users',cred.user.uid),{name,email,avatarURL:photoURL,createdAt:serverTimestamp()});
 $('signup').style.display='none';
};

$('btnSignin').onclick=async()=>{
 const email=$('siEmail').value.trim().toLowerCase(),pass=$('siPass').value.trim();
 await signInWithEmailAndPassword(auth,email,pass);
 $('signin').style.display='none';
};
$('btnLogout').onclick=()=>signOut(auth);

$('btnSend').onclick=async()=>{
 const text=$('composer').value.trim();
 if(!text||!activeThread)return;
 $('composer').value='';
 await addDoc(collection(db,'threads',activeThread,'messages'),{from:auth.currentUser.uid,text,ts:serverTimestamp()});
 ping();
};

async function ensureThreadByEmails(emails){
 const me=auth.currentUser;const q=await getDocs(query(collection(db,'users'),where('email','in',emails)));
 const ids=[me.uid];q.forEach(d=>ids.push(d.id));
 const newT=await addDoc(collection(db,'threads'),{members:ids,createdAt:serverTimestamp()});
 return newT.id;
}
$('globalEmailStart').onclick=async()=>{
 const email=$('globalEmailSearch').value.trim().toLowerCase();
 if(!email)return;
 const id=await ensureThreadByEmails([email]);
 $('globalEmailSearch').value='';
 openThread(id);
};

function openThread(id){
 activeThread=id;
 onSnapshot(query(collection(db,'threads',id,'messages'),orderBy('ts')),snap=>{
  const box=$('messageScroll');box.innerHTML='';
  snap.forEach(doc=>{
   const m=doc.data(),mine=m.from===auth.currentUser.uid;
   const div=document.createElement('div');
   div.className='w-full flex '+(mine?'justify-end':'justify-start');
   div.innerHTML=`<div class="bubble ${mine?'out':'in'} max-w-[70%] rounded-2xl px-3 py-2 ${mine?'bg-[var(--outgoing)]':'bg-white'}">${m.text}</div>`;
   box.appendChild(div);
  });
  box.scrollTop=box.scrollHeight;
 });
}

onAuthStateChanged(auth,user=>{
 if(user){
  $('auth').style.display='none';
  $('app').style.display='flex';
  $('meName').textContent=user.displayName;
  $('meEmail').textContent=user.email;
  $('meAvatar').src=user.photoURL||'icon-192.png';
 }else{
  $('auth').style.display='grid';
  $('app').style.display='none';
 }
});
</script>
</body>
</html>
