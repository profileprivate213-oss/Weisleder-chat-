<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weisleder Chat</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- PWA -->
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#229ED9" />
<link rel="apple-touch-icon" href="icon-192.png" />

<style>
  :root{ --brand:#229ED9; --outgoing:#D1F0FF; }
  .btn-brand{ background:var(--brand); color:#fff }
  .btn-brand:hover{ filter:brightness(.95) }
  .bubble{ position:relative }
  .bubble.in::after{ content:""; position:absolute; left:-6px; bottom:0; border-top:6px solid transparent; border-right:6px solid #fff }
  .bubble.out::after{ content:""; position:absolute; right:-6px; bottom:0; border-top:6px solid transparent; border-left:6px solid var(--outgoing) }
  *::-webkit-scrollbar{ width:8px; height:8px } *::-webkit-scrollbar-thumb{ background:rgba(100,100,100,.35); border-radius:9999px }
</style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-50">

<header class="fixed top-0 inset-x-0 z-20 bg-white/90 dark:bg-slate-900/90 backdrop-blur border-b border-slate-200 dark:border-slate-800">
  <div class="max-w-6xl mx-auto px-3 py-2 flex items-center gap-3">
    <div class="hidden md:flex items-center gap-2 font-semibold">
      <svg width="18" height="18" viewBox="0 0 24 24" class="fill-[var(--brand)]"><path d="M22 2 11 13l-1 6 4-3 8-14zM2 12l7 2"/></svg>
      Weisleder Chat
    </div>
    <div class="flex-1"></div>
    <div class="relative w-[62vw] md:w-[420px]">
      <input id="globalEmailSearch" class="w-full pl-3 pr-24 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 outline-none" placeholder="Search user by email" />
      <button id="globalEmailStart" class="absolute right-1 top-1 bottom-1 px-3 rounded-lg btn-brand text-sm">Start</button>
    </div>
  </div>
</header>

<div id="app" class="min-h-screen flex pt-16" style="display:none">
  <aside class="hidden md:flex w-80 flex-col border-r border-slate-200 dark:border-slate-800">
    <div class="px-3 py-3 flex items-center gap-2 text-white" style="background:var(--brand)">
      <img id="meAvatar" class="h-9 w-9 rounded-full object-cover bg-white/20" alt="avatar" />
      <div class="flex-1">
        <div id="meName" class="text-sm font-semibold">You</div>
        <div id="meEmail" class="text-xs/4 opacity-80">you@example.com</div>
      </div>
      <button id="btnProfile" class="px-2 py-1 rounded-md bg-white/20 hover:bg-white/30">Edit</button>
    </div>
    <div id="chatList" class="flex-1 overflow-y-auto pb-3 bg-white dark:bg-slate-900"></div>
    <div class="p-3 border-t border-slate-200 dark:border-slate-800 space-y-2">
      <button id="btnNewChat" class="w-full py-2 rounded-xl btn-brand">＋ New chat</button>
      <button id="btnLogout" class="w-full py-2 rounded-xl border">Sign out</button>
    </div>
  </aside>

  <main class="flex-1 flex flex-col">
    <div class="h-14 px-4 flex items-center gap-3 border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80">
      <img id="activeAvatar" class="h-9 w-9 rounded-full object-cover bg-slate-200 dark:bg-slate-700" />
      <div class="flex-1"><div id="activeName" class="text-sm font-semibold">Select a chat</div></div>
    </div>

    <div id="messageScroll" class="flex-1 overflow-y-auto px-3 md:px-8 py-3 space-y-2"></div>

    <div class="border-t border-slate-200 dark:border-slate-800 p-3 bg-white/80 dark:bg-slate-900/80">
      <div class="max-w-3xl mx-auto flex items-end gap-2">
        <textarea id="composer" class="flex-1 min-h-[44px] max-h-[160px] resize-y rounded-xl bg-slate-100 dark:bg-slate-800 px-3 py-2 outline-none" placeholder="Message"></textarea>
        <button id="btnSend" class="p-2 rounded-lg btn-brand">➤</button>
      </div>
    </div>
  </main>
</div>

<section id="auth" class="fixed inset-0 grid place-items-center bg-gradient-to-b from-sky-50 to-white dark:from-slate-900 dark:to-slate-900">
  <div class="w-[92vw] max-w-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow p-6 space-y-4">
    <div class="text-center text-2xl font-bold" style="color:var(--brand)">Weisleder Chat</div>
    <div class="grid grid-cols-2 gap-2">
      <button id="goSignup" class="py-2 rounded-xl btn-brand font-medium">Sign up</button>
      <button id="goSignin" class="py-2 rounded-xl border border-slate-200 dark:border-slate-700">Sign in</button>
    </div>
  </div>
</section>

<section id="signup" class="fixed inset-0 hidden place-items-center bg-black/30">
  <div class="w-[92vw] max-w-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow p-6">
    <h2 class="text-lg font-semibold mb-2">Create account</h2>
    <input id="suName" class="w-full mb-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800" placeholder="Name" />
    <input id="suEmail" class="w-full mb-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800" placeholder="Email" />
    <input id="suPass" type="password" class="w-full mb-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800" placeholder="Password" />
    <label class="text-sm block mb-1">Profile photo (optional)</label>
    <input id="suPhoto" type="file" accept="image/*" class="mb-3" />
    <button id="btnSignup" class="w-full py-2 rounded-xl btn-brand">Create</button>
  </div>
</section>

<section id="signin" class="fixed inset-0 hidden place-items-center bg-black/30">
  <div class="w-[92vw] max-w-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow p-6">
    <h2 class="text-lg font-semibold mb-2">Sign in</h2>
    <input id="siEmail" class="w-full mb-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800" placeholder="Email" />
    <input id="siPass" type="password" class="w-full mb-3 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800" placeholder="Password" />
    <button id="btnSignin" class="w-full py-2 rounded-xl btn-brand">Sign in</button>
  </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, signOut, updateProfile
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, collection, doc, setDoc, addDoc, query, where, getDocs,
  getDoc, onSnapshot, orderBy, serverTimestamp, updateDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL }
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

/* ✅ Your Firebase project (weisleder-ecc04) */
const firebaseConfig = {
  apiKey: "AIzaSyCE1IUp9u66uKthzwpLQ8qXrofQbD-FmII",
  authDomain: "weisleder-ecc04.firebaseapp.com",
  projectId: "weisleder-ecc04",
  storageBucket: "weisleder-ecc04.firebasestorage.app",
  messagingSenderId: "332588174671",
  appId: "1:332588174671:web:15c74f1d09729540f893a",
  measurementId: "G-XP39XFEGZN"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Try to init Storage (may fail if bucket not provisioned on your plan)
let storage = null;
try { storage = getStorage(app); } catch (e) { storage = null; }

const $ = (id)=>document.getElementById(id);
function beep(){
  const c=new (window.AudioContext||window.webkitAudioContext)();
  const o=c.createOscillator(), g=c.createGain(); o.frequency.value=800; g.gain.value=.08; o.connect(g); g.connect(c.destination);
  o.start(); setTimeout(()=>{o.stop(); c.close();},180);
}
async function notify(title, body){
  try{
    if(document.hasFocus()) return;
    if(Notification.permission==="granted") new Notification(title,{body,icon:"icon-192.png"});
    else if(Notification.permission!=="denied") await Notification.requestPermission();
  }catch{}
}

$('goSignup').onclick=()=>$('signup').style.display='grid';
$('goSignin').onclick=()=>$('signin').style.display='grid';
$('btnLogout').onclick=()=>signOut(auth);

$('btnSignup').onclick=async()=>{
  const name=$('suName').value.trim();
  const email=$('suEmail').value.trim().toLowerCase();
  const pass=$('suPass').value.trim();
  if(!name||!email||!pass) return alert("Fill all fields");
  const cred=await createUserWithEmailAndPassword(auth,email,pass);

  // avatar upload (graceful fallback if Storage locked)
  let photoURL=null;
  const file=$('suPhoto').files[0];
  if(file && storage){
    try{
      const ref=sRef(storage,`avatars/${cred.user.uid}.jpg`);
      await uploadBytes(ref,file);
      photoURL=await getDownloadURL(ref);
    }catch(err){
      console.warn("Avatar upload skipped:", err?.message||err);
      alert("Profile photo couldn't be saved yet (Storage not enabled). You can add it later.");
    }
  }

  await updateProfile(cred.user,{displayName:name, photoURL});
  await setDoc(doc(db,'users',cred.user.uid),{
    name, email, avatarURL: photoURL||null, createdAt: serverTimestamp()
  });
  $('signup').style.display='none';
};

$('btnSignin').onclick=async()=>{
  const email=$('siEmail').value.trim().toLowerCase();
  const pass=$('siPass').value.trim();
  await signInWithEmailAndPassword(auth,email,pass);
  $('signin').style.display='none';
};

$('globalEmailStart').onclick=async()=>{
  const email=$('globalEmailSearch').value.trim().toLowerCase();
  if(!email) return;
  const me=auth.currentUser; if(!me) return alert("Sign in first");
  const q=query(collection(db,'users'), where('email','==',email));
  const snap=await getDocs(q);
  if(snap.empty) return alert("No user with that email.");
  const otherId=snap.docs[0].id;
  const tRef=await addDoc(collection(db,'threads'),{members:[me.uid,otherId],createdAt:serverTimestamp()});
  $('globalEmailSearch').value='';
  openThread(tRef.id);
};

let activeThread=null;
$('btnSend').onclick=async()=>{
  const text=$('composer').value.trim();
  if(!text||!activeThread) return;
  $('composer').value='';
  await addDoc(collection(db,'threads',activeThread,'messages'),{from:auth.currentUser.uid,text,ts:serverTimestamp()});
  beep();
};

function renderMessage(m){
  const mine=m.from===auth.currentUser.uid;
  const div=document.createElement('div');
  div.className='w-full flex '+(mine?'justify-end':'justify-start');
  div.innerHTML=`<div class="bubble ${mine?'out':'in'} max-w-[74%] rounded-2xl px-3 py-2 ${mine?'bg-[var(--outgoing)]':'bg-white'}">${m.text??''}</div>`;
  return div;
}

function openThread(id){
  activeThread=id;
  (async()=>{
    const t=await getDoc(doc(db,'threads',id));
    const data=t.data()||{};
    const other=(data.members||[]).find(x=>x!==auth.currentUser.uid);
    if(other){
      const u=await getDoc(doc(db,'users',other)); const ud=u.data()||{};
      $('activeName').textContent=ud.name||ud.email||'Chat';
      $('activeAvatar').src=ud.avatarURL||'icon-192.png';
    }
  })();

  const box=$('messageScroll');
  const q=query(collection(db,'threads',id,'messages'), orderBy('ts'));
  onSnapshot(q, snap=>{
    let incoming=false; box.innerHTML='';
    snap.forEach(d=>{ const m=d.data(); if(m.from!==auth.currentUser.uid) incoming=true; box.appendChild(renderMessage(m)); });
    box.scrollTop=box.scrollHeight;
    if(incoming){ beep(); notify('New message','You received a message.'); }
  });
}

$('btnProfile').onclick=async()=>{
  const me=auth.currentUser; if(!me) return;
  const newName=prompt("Edit name", me.displayName||'');
  if(newName && newName.trim()){
    await updateProfile(me,{displayName:newName.trim()});
    await updateDoc(doc(db,'users',me.uid),{name:newName.trim()});
    $('meName').textContent=newName.trim();
  }
};
$('btnNewChat').onclick=()=>$('globalEmailSearch').focus();

onAuthStateChanged(auth, async(user)=>{
  if(user){
    $('auth').style.display='none';
    $('app').style.display='flex';
    $('meName').textContent=user.displayName||'(no name)';
    $('meEmail').textContent=user.email;
    $('meAvatar').src=user.photoURL||'icon-192.png';

    const list=$('chatList');
    const q=query(collection(db,'threads'), where('members','array-contains', user.uid));
    onSnapshot(q, async(snap)=>{
      list.innerHTML='';
      for(const d of snap.docs){
        const t=d.data(), id=d.id;
        const other=(t.members||[]).find(x=>x!==user.uid);
        let title='Chat', avatar='icon-192.png';
        if(other){
          const u=await getDoc(doc(db,'users',other)); const ud=u.data()||{};
          title=ud.name||ud.email||'Chat'; avatar=ud.avatarURL||avatar;
        }
        const row=document.createElement('button');
        row.className='w-full flex items-center gap-3 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-800';
        row.innerHTML=`<img class="h-9 w-9 rounded-full object-cover" src="${avatar}"/><div class="flex-1 text-left text-sm">${title}</div>`;
        row.onclick=()=>openThread(id);
        list.appendChild(row);
      }
    });

    if(Notification && Notification.permission==="default"){ try{ await Notification.requestPermission(); }catch{} }
  }else{
    $('auth').style.display='grid';
    $('app').style.display='none';
  }
});

/* PWA */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{ navigator.serviceWorker.register("./service-worker.js").catch(()=>{}); });
}
</script>
</body>
</html>
